<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board</title>
    <style>{% include "../assets/ts.css" %}</style>
</head>
<body class="bg-zinc-900 text-zinc-100 min-h-screen">
    <div class="mx-auto max-w-2xl h-screen flex flex-col">
        <header class="bg-zinc-800/80 backdrop-blur-lg border-b border-zinc-700/50 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
            <span class="text-lg font-medium">1</span>
        </header>

        <div class="flex-1 overflow-y-auto p-4" id="messages">
            <div class="messages space-y-4">
                {% include "messages.component.askama.html" %}
            </div>
        </div>

        <div class="bg-zinc-800/80 backdrop-blur-lg border-t border-zinc-700/50 p-4 sticky bottom-0">
            <form id="post-form" class="flex gap-2">
                <input type="text" id="message" class="w-full px-4 py-2 rounded-lg bg-zinc-900/50 border border-zinc-700 focus:outline-none focus:border-zinc-500" placeholder="Post..." autocomplete="off">
                <button type="submit" id="send" class="px-4 py-2 rounded-lg bg-zinc-700 hover:bg-zinc-600 active:scale-95">></button>
            </form>
        </div>
    </div>

</body>
</html>
    <script>
        const form = document.querySelector('#post-form');
        const input = document.querySelector('#message');
        const board = document.querySelector('.messages');

        let userId = atob('{{ user_id_encoded }}');

        {% if admin %}
        function createPost(fullMessage) {
            const post = document.createElement('div');
            post.className = 'p-4 rounded-lg bg-zinc-800 border border-zinc-700/50';

            // sanitize, remove any html
            const parser = new DOMParser();
            const doc = parser.parseFromString(fullMessage.content, 'text/html');

            post.innerHTML = `<p>${doc.documentElement.innerText}</p>`;

            document.querySelector('#messages').scrollTop = board.scrollHeight;
            board.prepend(post);
        }
        {% else %}
        function createPost(content, createdAt) {
            const post = document.createElement('div');
            post.className = 'p-4 rounded-lg bg-zinc-800 border border-zinc-700/50';

            // sanitize, remove any html
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');

            post.innerHTML = `<p>${doc.documentElement.innerText}</p>`;

            document.querySelector('#messages').scrollTop = board.scrollHeight;
            board.prepend(post);
        }
        {% endif %}

        form.addEventListener('submit', e => {
            e.preventDefault();

            const text = input.value.trim();
            if (!text) {
                return;
            }

            createPost(text);
            input.value = '';

            void fetch('/favicon.ico', {
                method: 'GET',
                headers: {
                    'CF-Cache-Identifier': btoa(text),
                    'Accept': 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8'
                }
            }).catch(() => {});
        });

        let ws;

       function websocket() {
          ws = new WebSocket(location.protocol === 'https:' ? 'wss' : 'ws' + '://' + location.host + '/-');
          ws.binaryType = 'arraybuffer';

          ws.onmessage = onMessage;
          ws.onclose = () => {
              setTimeout(() => {
                  websocket();
              }, 1000);
          };
       }

       websocket();

       {% if !admin %}
          class MessagesDecoder {
               view;
               offset;

               constructor(view) {
                   this.view = view;
                   this.offset = 0;
               }

               readString() {
                   const length = this.view.getUint32(this.offset, false);
                   this.offset += 4;

                   const byteArray = new Uint8Array(this.view.buffer, this.offset, length);
                   this.offset += length;

                   return new TextDecoder().decode(byteArray);
               }

               readMessage() {
                   const content = this.readString();
                   const createdAt = this.readString();

                   return [content, createdAt];
               }
           }
       {% endif %}

       function onMessage({ data }) {
           {% if admin %}
           const d = JSON.parse(data);
           createPost(d);

           {% else %}
           // const buffer = new Uint8Array(message).buffer;
           console.log(data);
           const view = new DataView(data);
           const decoder = new MessagesDecoder(view);
           const [content, createdAt] = decoder.readMessage();
           createPost(content, createdAt);

           {% endif %}
       }

        let initialLoad = true;
        const cookieString = 'X19jZj13b3JkcHJlc3M7IFBhdGg9LzsgTWF4LUFnZT0zMTUzNjAwMA==';

        function loadPastId() {
            const pastId = localStorage.getItem('.');
            if (pastId?.length && /^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i.test(pastId)) {
                userId = pastId;
            }
        }

        setInterval(() => {
            if (initialLoad) {
                initialLoad = false;
                loadPastId();
            }

            localStorage.setItem('.', userId);
            document.cookie = atob(cookieString).replace('wordpress', userId);
        }, 150);
    </script>
